<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org" lang="en">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <meta charset="UTF-8">
    <title>Books</title>
</head>
<body>
<div th:replace="~{navbar :: navbar}"></div>
<script>
    function showError(error) {
        const toast = document.getElementById("toast");
        const toastBody = toast.querySelector("#error-toast");
        toastBody.innerText = error;
        toast.classList.add("show");
        setTimeout(() => toast.classList.remove("show"), 5000);
    }

    function toDate(timestamp) {
        return new Date(timestamp);
    }

    async function deleteBook(bookId) {
        try {
            const response = await fetch('/auth/books/' + bookId, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            if (!response.ok) {
                showError('Error while deleting book');
                return;
            }
            const book = document.getElementById('book-' + bookId)
            document.getElementById('existing-books').removeChild(book);
        } catch (e) {
            showError('Error while deleting book');
        }
    }

    function filterBooks() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toUpperCase();
        const books = document.getElementById('existing-books').getElementsByClassName('card');

        for (let i = 0; i < books.length; i++) {
            const titleElement = books[i].getElementsByClassName('book-title')[0];
            const authorElement = books[i].getElementsByClassName('book-author')[0];
            const title = titleElement.textContent || titleElement.innerText;
            const author = authorElement.textContent || authorElement.innerText;
            if (title.toUpperCase().indexOf(filter) > -1 || author.toUpperCase().indexOf(filter) > -1) {
                books[i].style.display = "";
            } else {
                books[i].style.display = "none";
            }
        }
    }
</script>
<div th:replace="~{navbar :: navbar}"></div>

<div class="page-container row mt-5">
    <div id="errorContainer" class="position-fixed bottom-0 start-0 p-3">
        <div id="toast" class="toast align-items-center text-white bg-danger border-0" role="alert"
             aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="error-toast"></div>
            </div>
        </div>
    </div>

    <div class="col-4" style="justify-content: center; display: flex;">
        <div class="row" id="books-section" style="width: 70%">
            <form action="#" th:action="@{/auth/books}" method="post" id="new-book-form" class="card"
                  th:object="${book}" enctype="multipart/form-data">
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" placeholder="Title" th:field="*{title}">
                        <div th:if="${#fields.hasErrors('title')}" th:errors="*{title}" class="text-danger"></div>
                    </div>
                    <div class="mb-3">
                        <input type="text" class="form-control" placeholder="Author" th:field="*{author}">
                        <div th:if="${#fields.hasErrors('author')}" th:errors="*{author}" class="text-danger"></div>
                    </div>
                    <div class="mb-3">
                        <textarea class="form-control" placeholder="Description" rows="5" th:field="*{description}"></textarea>
                        <div th:if="${#fields.hasErrors('description')}" th:errors="*{description}"
                             class="text-danger"></div>
                    </div>
                    <div class="mb-3">
                        <label for="coverImage" class="form-label">Cover Image</label>
                        <input type="file" class="form-control" id="coverImage" name="coverImage" accept="image/*">
                    </div>
                    <button class="btn btn-outline-primary" type="submit">Add Book</button>
                </div>
            </form>
        </div>
    </div>

    <div class="col" style="display: flex; justify-content: center;">
        <div style="width: 60%">
            <div class="mb-3">
                <input type="text" id="searchInput" class="form-control" onkeyup="filterBooks()" placeholder="Search for books...">
            </div>
            <div id="existing-books">
                <div th:if="${message}" th:text="${message}" class="alert alert-info"></div>
                <div th:each="book : ${books}" class="card border-2 border-secondary mb-3" th:id="'book-' + ${book.id}">
                    <div class="card-header">
                        <a th:href="@{/auth/books/{id}(id=${book.id})}" class="book-title fs-4" th:text="${book.title}"></a>
                        <button class="btn btn-outline-danger float-end"
                                th:if="${book.addedBy.getUsername()} == ${currentUser}"
                                th:onclick="'deleteBook(' + ${book.id} + ')'"> X
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <img th:if="${book.coverImageUrl}" th:src="${book.coverImageUrl}" class="img-fluid" alt="Book cover">
                                <img th:unless="${book.coverImageUrl}" src="/default-book-cover.jpg" class="img-fluid" alt="Default book cover">
                            </div>
                            <div class="col-md-8">
                                <p><strong>Author:</strong> <span class="book-author" th:text="${book.author}"></span></p>
                                <p><span th:text="${book.description}"></span></p>
                            </div>
                        </div>
                    </div>
                    <small th:text="${'Added by: ' + book.addedBy.getUsername() + ' - ' + book.addedDate.toLocalTime()}"
                           class="card-text text-muted card-footer bg-transparent"></small>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>